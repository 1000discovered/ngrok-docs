"use strict";(self.webpackChunkngrok_doc=self.webpackChunkngrok_doc||[]).push([[13446],{26178:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var a=t(51163),r=(t(59496),t(49613));const o={sidebar_label:"Getting Started",title:"ngrok Kubernetes Ingress Controller on EKS",description:"ngrok Kubernetes Ingress Controller on Google Kubernetes Engine (GKE)",tags:["kubernetes","k8s","google kubernetes engine","gke","google","ingress controller"]},l="Google Kubernetes Engine (GKE)",i={unversionedId:"integrations/google-gke/google-kubernetes-engine",id:"integrations/google-gke/google-kubernetes-engine",title:"ngrok Kubernetes Ingress Controller on EKS",description:"ngrok Kubernetes Ingress Controller on Google Kubernetes Engine (GKE)",source:"@site/docs/integrations/google-gke/google-kubernetes-engine.md",sourceDirName:"integrations/google-gke",slug:"/integrations/google-gke/google-kubernetes-engine",permalink:"/docs/integrations/google-gke/google-kubernetes-engine",draft:!1,editUrl:"https://github.com/ngrok/ngrok-docs/edit/main/docs/integrations/google-gke/google-kubernetes-engine.md",tags:[{label:"kubernetes",permalink:"/docs/tags/kubernetes"},{label:"k8s",permalink:"/docs/tags/k-8-s"},{label:"google kubernetes engine",permalink:"/docs/tags/google-kubernetes-engine"},{label:"gke",permalink:"/docs/tags/gke"},{label:"google",permalink:"/docs/tags/google"},{label:"ingress controller",permalink:"/docs/tags/ingress-controller"}],version:"current",lastUpdatedBy:"Russ Savage",lastUpdatedAt:1692824825,formattedLastUpdatedAt:"Aug 23, 2023",frontMatter:{sidebar_label:"Getting Started",title:"ngrok Kubernetes Ingress Controller on EKS",description:"ngrok Kubernetes Ingress Controller on Google Kubernetes Engine (GKE)",tags:["kubernetes","k8s","google kubernetes engine","gke","google","ingress controller"]},sidebar:"docs",previous:{title:"Google Kubernetes Engine (GKE)",permalink:"/docs/integrations/google-gke/"},next:{title:"Heroku",permalink:"/docs/integrations/heroku/"}},s={},p=[{value:"<strong>Step 1</strong>: Ensure <code>kubectl</code> can speak with your cluster",id:"prereqs",level:2},{value:"<strong>Step 2</strong>: Install the ngrok Ingress Controller",id:"install-the-ngrok-ingress-controller",level:2},{value:"<strong>Step 3</strong>: Install a Sample Application",id:"install-a-sample-application",level:2}],g={toc:p},c="wrapper";function m(e){let{components:n,...o}=e;return(0,r.kt)(c,(0,a.Z)({},g,o,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"google-kubernetes-engine-gke"},"Google Kubernetes Engine (GKE)"),(0,r.kt)("hr",null),(0,r.kt)("admonition",{title:"TL;DR",type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"To use the ngrok Ingress Controller with Google Kubernetes Engine:"),(0,r.kt)("ol",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"#prereqs"},"Ensure ",(0,r.kt)("inlineCode",{parentName:"a"},"kubectl")," can speak with your cluster")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"#install-the-ngrok-ingress-controller"},"Install the ngrok Ingress Controller")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"#install-a-sample-application"},"Install a sample application")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"#add-edge-security"},"Add edge security to your app"),"\n:::")),(0,r.kt)("h2",{parentName:"admonition",id:"introduction"},"Introduction"),(0,r.kt)("p",{parentName:"admonition"},"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ngrok/kubernetes-ingress-controller"},"ngrok Ingress Controller for Kubernetes")," is our official open-source controller for adding public and secure ingress traffic to your k8s services. It works out of the box with Google Kubernetes Engine cluster to provide ingress to your services no matter the network configuration, as long as it has outbound access to the ngrok service. This allows ngrok to be portable and work seamlessly across any type of infrastructure.")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"An ",(0,r.kt)("a",{parentName:"li",href:"https://ngrok.com/signup"},"ngrok account"),"."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/tools/install-kubectl/"},"kubectl")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://helm.sh/docs/intro/install/"},"Helm 3.0.0+")),(0,r.kt)("li",{parentName:"ol"},"A ",(0,r.kt)("a",{parentName:"li",href:"https://cloud.google.com/kubernetes-engine/docs/deploy-app-cluster"},"GKE cluster"),"\n:::")),(0,r.kt)("h2",{id:"prereqs"},(0,r.kt)("strong",{parentName:"h2"},"Step 1"),": Ensure ",(0,r.kt)("inlineCode",{parentName:"h2"},"kubectl")," can speak with your cluster"),(0,r.kt)("p",null,"With a Google Kubernetes Engine (GKE) cluster, authentication for ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl")," happens with a credential helper. So in-order to deploy the ngrok Ingress Controller to your cluster, you'll need to ensure that you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"gcloud")," CLI and that the credential helper is available."),(0,r.kt)("p",null,"Let's ensure that you have the ",(0,r.kt)("inlineCode",{parentName:"p"},"gcloud")," CLI installed and configured with your Google Cloud credentials. You can confirm this works and you're authenticated correctly by running the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"gcloud auth list\n")),(0,r.kt)("p",null,"If you see your correct Google account listed, you should be all set. If not, you can run ",(0,r.kt)("inlineCode",{parentName:"p"},"gcloud auth login")," to authenticate with your Google account."),(0,r.kt)("p",null,"Next, we'll ensure that the credential helper is available. Run the following command to confirm that the credential helper is available:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"gcloud components install gke-gcloud-auth-plugin\n")),(0,r.kt)("p",null,"Finally, we can add the cluster to our KUBECONFIG:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"gcloud container clusters get-credentials --region <cluster-region> --project <cluster-project> <cluster-name>\n")),(0,r.kt)("h2",{id:"install-the-ngrok-ingress-controller"},(0,r.kt)("strong",{parentName:"h2"},"Step 2"),": Install the ngrok Ingress Controller"),(0,r.kt)("p",null,"Now we can install the ngrok Ingress Controller to provide ingress to our services. We'll use Helm to install the ngrok Ingress Controller into our cluster."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Add the ngrok Ingress Controller Helm repo"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"helm repo add ngrok https://ngrok.github.io/kubernetes-ingress-controller\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Set your environment variables with your ngrok credentials. Replace ",(0,r.kt)("inlineCode",{parentName:"p"},"[AUTHTOKEN]")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"[API_KEY]")," with your Authtoken and API key for your account."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"export NGROK_AUTHTOKEN=[AUTHTOKEN]\nexport NGROK_API_KEY=[API_KEY]\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Next, we'll install the ngrok Ingress Controller into our cluster."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"helm install ngrok-ingress-controller ngrok/kubernetes-ingress-controller \\\n  --namespace ngrok \\\n  --set fullnameOverride=ngrok-ingress-controller \\\n  --set credentials.apiKey=$NGROK_API_KEY \\\n  --set credentials.authtoken=$NGROK_AUTHTOKEN\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Verify the ngrok Ingress Controller is installed and all its pods are healthy"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get pods -l 'app.kubernetes.io/name=kubernetes-ingress-controller' -n ngrok\nNAME                                                READY   STATUS    RESTARTS      AGE\nngrok-ingress-controller-manager-5b796c88f7-k7v6z   2/2     Running   1 (64s ago)   67s\n")))),(0,r.kt)("h2",{id:"install-a-sample-application"},(0,r.kt)("strong",{parentName:"h2"},"Step 3"),": Install a Sample Application"),(0,r.kt)("p",null,"Create a manifest file (for example ",(0,r.kt)("inlineCode",{parentName:"p"},"ngrok-manifest.yaml"),") with the following contents. You will need to replace the ",(0,r.kt)("inlineCode",{parentName:"p"},"NGROK_DOMAIN")," on line 45 with your own custom value. This is the URL you will use to access your service from anywhere. If you're on a free account, it must be on a static subdomain which you can claim by logging into your account and following the instructions on the claim static subdomain banner. For paid accounts, you can use a custom domain or a subdomain of ",(0,r.kt)("inlineCode",{parentName:"p"},"ngrok.app")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"ngrok.dev")," (for example, ",(0,r.kt)("inlineCode",{parentName:"p"},"username-loves-ingress.ngrok.app")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"k8s.example.com"),")."),(0,r.kt)("admonition",{title:"Notes:",type:"tip"},(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},"Lines 1-34: Create the 2048 app service and deployment"),(0,r.kt)("li",{parentName:"ul"},"Lines 35-54 (highlighted): Create the ngrok Ingress Controller. Line 45 determines the ingress URL for public requests.\n:::")),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:"showLineNumbers",showLineNumbers:!0},"apiVersion: v1\nkind: Service\nmetadata:\n  name: game-2048\n  namespace: ngrok-ingress-controller\nspec:\n  ports:\n    - name: http\n      port: 80\n      targetPort: 80\n  selector:\n    app: game-2048\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: game-2048\n  namespace: ngrok-ingress-controller\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: game-2048\n  template:\n    metadata:\n      labels:\n        app: game-2048\n    spec:\n      containers:\n        - name: backend\n          image: alexwhen/docker-2048\n          ports:\n            - name: http\n              containerPort: 80\n---\n# highlight-start\n# ngrok Ingress Controller Configuration\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: game-2048-ingress\n  namespace: ngrok-ingress-controller\nspec:\n  ingressClassName: ngrok\n  rules:\n    - host: NGROK_DOMAIN\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: game-2048\n                port:\n                  number: 80\n# highlight-end\n")),(0,r.kt)("ol",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Apply the manifest file to your k8s cluster."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f ngrok-manifest.yaml\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Note:")," If you get an error when applying the manifest, double check that you've updated the ",(0,r.kt)("inlineCode",{parentName:"p"},"NGROK_DOMAIN")," value and try again.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"To confirm the manifest is successfully applied, go to the ",(0,r.kt)("a",{parentName:"p",href:"https://dashboard.ngrok.com"},"ngrok Dashboard")," and click ",(0,r.kt)("a",{parentName:"p",href:"https://dashboard.ngrok.com/edge-configurations"},"Edge Configurations"),". You should see a new Edge Configuration for your cluster with the name matching your URL (1) \u2014 for example: ",(0,r.kt)("inlineCode",{parentName:"p"},"my-awesome-k8s-cluster.ngrok.app"),". Also note that your some of your cluster configurations are presented int the dashboard as annotations (2)."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"ingress created",src:t(30996).Z,width:"1166",height:"378"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Access your ingress URL using the subdomain you chose in the manifest file above (i.e. ",(0,r.kt)("inlineCode",{parentName:"p"},"https://my-awesome-k8s-cluster.ngrok.app"),") to confirm the 2048 app is accessible from the internet. If you forgot what url you chose, you can always run ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl get ingresses --namespace=ngrok-ingress-controller")," to see what it is."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"application public",src:t(18689).Z,width:"957",height:"629"})))),(0,r.kt)("h2",{parentName:"admonition",id:"add-edge-security"},"Step 4: Add edge security to your app"),(0,r.kt)("p",{parentName:"admonition"},"The ngrok Ingress Controller for Kubernetes provides custom resource definitions (CRDs) for additional edge features available in ngrok. In this example, we're expanding the Ingress Controller with Google OAuth to allow access only from users with the email domains ",(0,r.kt)("inlineCode",{parentName:"p"},"@acme.com")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"@ngrok.com")," and to apply a circuit breaker to your app at 80% (requires a paid account). These features are enforced at the ngrok edge, ensuring only authorized users can access your app."),(0,r.kt)("p",{parentName:"admonition"},"As before, you will need to update line 46 of this manifest with your ",(0,r.kt)("inlineCode",{parentName:"p"},"NGROK_DOMAIN")," in the Ingress object.")),(0,r.kt)("p",null,"This example is very similar to the previous version, with the following changes:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Lines 41-42: Associates your Ingress Controller with the configuration ",(0,r.kt)("inlineCode",{parentName:"li"},"oauth-and-circuit-breaking")," via annotation"),(0,r.kt)("li",{parentName:"ul"},"Lines 57-75: Sets the edge configuration as a custom CRD (NgrokModuleSet)."),(0,r.kt)("li",{parentName:"ul"},"Lines 64-69: Sets the circuit breaker module over 50% threshold."),(0,r.kt)("li",{parentName:"ul"},"Lines 70-74: Sets the OAuth module to allow access only for users with the email domains ",(0,r.kt)("inlineCode",{parentName:"li"},"@acme.com")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"@ngrok.com"),".\n:::")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:"showLineNumbers",showLineNumbers:!0},'apiVersion: v1\nkind: Service\nmetadata:\n  name: game-2048\n  namespace: ngrok-ingress-controller\nspec:\n  ports:\n    - name: http\n      port: 80\n      targetPort: 80\n  selector:\n    app: game-2048\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: game-2048\n  namespace: ngrok-ingress-controller\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: game-2048\n  template:\n    metadata:\n      labels:\n        app: game-2048\n    spec:\n      containers:\n        - name: backend\n          image: alexwhen/docker-2048\n          ports:\n            - name: http\n              containerPort: 80\n---\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: game-2048-ingress\n  namespace: ngrok-ingress-controller\n  # highlight-start\n  annotations:\n    k8s.ngrok.com/modules: oauth-and-circuit-breaking\n  # highlight-end\nspec:\n  ingressClassName: ngrok\n  rules:\n    - host: NGROK_DOMAIN\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: game-2048\n                port:\n                  number: 80\n---\n# highlight-start\n# Module configurations for Circuit Breaking and OAuth\nkind: NgrokModuleSet\napiVersion: ingress.k8s.ngrok.com/v1alpha1\nmetadata:\n  name: oauth-and-circuit-breaking\n  namespace: ngrok-ingress-controller\nmodules:\n  circuitBreaker:\n    trippedDuration: 10s\n    rollingWindow: 10s\n    numBuckets: 10\n    volumeThreshold: 20\n    errorThresholdPercentage: "0.50"\n  oauth:\n    google:\n      emailDomains:\n        - acme.com\n        - ngrok.com\n---\n# highlight-end\n')),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Save your file and reapply the manifest file:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f ngrok-manifest.yaml\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Note:")," Again, if you get an error when applying the manifest, double check that you've updated the ",(0,r.kt)("inlineCode",{parentName:"p"},"NGROK_DOMAIN")," value and try again.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"To confirm the circuit breaking configuration is successfully applied:"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Go to ",(0,r.kt)("a",{parentName:"p",href:"https://dashboard.ngrok.com"},"ngrok Dashboard")," > ",(0,r.kt)("a",{parentName:"p",href:"https://dashboard.ngrok.com/edge-configurations"},"Edge Configurations"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click the edge configuration that matches your URL.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"On the left hand side, click Circuit Breaker.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Notice how the circuit breaker configuration matches your manifest file."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"circuit breaker",src:t(40698).Z,width:"2411",height:"1092"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click OAuth and confirm how the oauth configuration matches your manifest file."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"circuit breaker",src:t(55751).Z,width:"2169",height:"1092"}))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Access your App and confirm that you got the expect authentication behavior:"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"ingress controller in action",src:t(91929).Z,width:"960",height:"540"})))))}m.isMDXComponent=!0},91929:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/ingress-controller-in-action-2-d38054b8990fe8c111b10312543ef345.gif"},30996:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/k8s-ingress-app-1-b1ce8a7f6c2ffc59d496ee03c8594bab.png"},18689:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/k8s-ingress-app-2-9e75ffc62397d3ed7dc2fcfcb932713e.png"},40698:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/k8s-ingress-app-3-f5e8e0e88ef0fc659918699c53d3f977.png"},55751:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/k8s-ingress-app-4-3364fbbcef57a5370cfcfbbe82e194e7.png"}}]);